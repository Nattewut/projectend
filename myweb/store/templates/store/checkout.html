{% extends 'store/main.html' %}
{% load static %}
{% block content %}
<div class="row">
    <div class="col-lg-6">
        <div class="box-element" id="form-wrapper">
            <form id="form">
                {% csrf_token %}
                <div id="user-info">
                    <div class="form-field">
                        <input required class="form-control" type="text" name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠..">
                    </div>
                    <div class="form-field">
                        <input required class="form-control" type="email" name="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•..">
                    </div>
                </div>

                <div id="shipping-info">
                    <hr>
                    <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á:</p>
                    <hr>
                    <div class="form-field">
                        <input class="form-control" type="text" name="address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="city" placeholder="‡πÄ‡∏°‡∏∑‡∏≠‡∏á..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="state" placeholder="‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="zipcode" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå..">
                    </div>
                    <div class="form-field">
                        <input class="form-control" type="text" name="country" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®..">
                    </div>
                </div>

                <hr>
                <input id="form-button" class="btn btn-success btn-block" type="submit" value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠">
            </form>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="box-element">
            <a class="btn btn-outline-dark" href="{% url 'cart' %}">&#x2190; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</a>
            <hr>
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            <hr>
            {% for item in items %}
            <div class="cart-row">
                <div style="flex:2"><img class="row-image" src="{{item.product.imageURL}}"></div>
                <div style="flex:2"><p>{{item.product.name}}</p></div>
                <div style="flex:1"><p>${{item.product.price|floatformat:2}}</p></div>
                <div style="flex:1"><p>x{{item.quantity}}</p></div>
            </div>
            {% endfor %}
            <h5>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:   {{order.get_cart_items}}</h5>
            <h5>‡∏£‡∏ß‡∏°:   ${{order.get_cart_total|floatformat:2}}</h5>
        </div>
        
        <div class="box-element" id="pay-now-section" style="display:none;">
            <button id="checkout-button" class="btn btn-success btn-block">‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script type="text/javascript">
    var stripe = Stripe("{{ STRIPE_PUBLIC_KEY|default:'' }}");

    var form = document.getElementById('form');
    form.addEventListener('submit', function(e){
        e.preventDefault();
        document.getElementById('form-wrapper').style.display = 'none';
        document.getElementById('pay-now-section').style.display = 'block';
    });

    var checkoutButton = document.getElementById('checkout-button');
    
    checkoutButton.addEventListener('click', function () {
        let csrfToken = "{{ csrf_token }}";
        console.log("üîç CSRF Token:", csrfToken);

        // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
        let name = document.querySelector("input[name='name']").value.trim();
        let email = document.querySelector("input[name='email']").value.trim();
        let address = document.querySelector("input[name='address']").value.trim();
        let city = document.querySelector("input[name='city']").value.trim();
        let state = document.querySelector("input[name='state']").value.trim();
        let zipcode = document.querySelector("input[name='zipcode']").value.trim();
        let country = document.querySelector("input[name='country']").value.trim();

        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á
        if (!name || !email) {
            alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            return;
        }

        let orderData = {
            "form": {
                "name": name,
                "email": email
            },
            "shipping": {
                "address": address,
                "city": city,
                "state": state,
                "zipcode": zipcode,
                "country": country
            }
        };

        console.log("üîç Data being sent:", orderData);

        fetch('/process_order/', {
            method: 'POST',
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
            },
            body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(sessionId => {
            if (sessionId.id) {
                return stripe.redirectToCheckout({ sessionId: sessionId.id });
            } else {
                console.error("‚ùå Stripe session ID missing:", sessionId);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á session ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ");
            }
        })
        .catch(error => {
            console.error("‚ùå Error:", error);
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
        });
    });
</script>

{% endblock content %}
